name: Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  semantic-release:
    runs-on: macos-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install workspace dependencies
        run: npm ci

      - name: Install menubar dependencies
        run: npm --prefix apps/menu-bar ci

      - name: Run semantic-release
        if: github.ref_type == 'branch'
        run: npm run release

      - name: Determine release version
        if: github.ref_type == 'tag'
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME#v}" >> "${GITHUB_ENV}"

      - name: Sync project version from tag
        if: github.ref_type == 'tag'
        run: node scripts/set-version.mjs "$RELEASE_VERSION"

      - name: Build distribution from tag
        if: github.ref_type == 'tag'
        run: |
          npm run build
          npm --prefix apps/menu-bar run tauri:build
          node scripts/collect-artifacts.mjs

      - name: Upload macOS artifacts
        if: github.ref_type == 'tag'
        uses: actions/upload-artifact@v4
        with:
          name: namefix-${{ env.RELEASE_VERSION }}-macos
          path: artifacts/*
          if-no-files-found: error
